<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>SkillSync MVP</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; background-color: #f4f7f6; color: #333; }
        .box { background: white; border: 1px solid #ddd; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; text-align: center; }
        
        /* Chat st√≠lusok */
        #chat-window { height: 400px; overflow-y: auto; background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-direction: column; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 80%; line-height: 1.5; white-space: pre-wrap; }
        .user-msg { background: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .ai-msg { background: #e9ecef; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        /* F√°jllista st√≠lusok */
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .file-item:last-child { border-bottom: none; }
        .delete-btn { background: #dc3545; padding: 5px 10px; font-size: 0.8rem; }
        .delete-btn:hover { background: #c82333; }

        /* Inputok */
        input[type="text"] { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; }
        button { padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; font-weight: bold; }
        button:hover { background: #218838; }
        .upload-section { display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>
    <h1>üß† SkillSync V√°llalati Asszisztens</h1>

    <div class="box">
        <h3>üìÑ Dokumentumok Kezel√©se</h3>
        <div class="upload-section">
            <input type="file" id="pdfFile" accept=".pdf">
            <button onclick="uploadFile()">Felt√∂lt√©s</button>
        </div>
        <p id="uploadStatus" style="font-size: 0.9rem; margin-top: 10px;"></p>
        
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        
        <h4>Aktu√°lis index tartalom:</h4>
        <div id="file-list">
            <em>Bet√∂lt√©s...</em>
        </div>
    </div>

    <div class="box">
        <h3>üí¨ Intelligens Chat</h3>
        <div id="chat-window"></div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="userInput" placeholder="K√©rdezz a dokumentumokr√≥l..." onkeypress="if(event.key==='Enter') askChat()">
            <button onclick="askChat()">K√ºld√©s</button>
        </div>
    </div>

    <script>
    // Session azonos√≠t√≥ kezel√©se (b√∂ng√©sz≈ë bez√°r√°sig vagy t√∂rl√©sig megmarad)
    let currentSessionId = localStorage.getItem('chat_session_id') || crypto.randomUUID();
    localStorage.setItem('chat_session_id', currentSessionId);

    let chatHistory = [];
    const tenant_id = "default";

    window.onload = refreshFileList;

        async function refreshFileList() {
            const listDiv = document.getElementById('file-list');
            try {
                const res = await fetch(`/files/${tenant_id}`);
                const files = await res.json();
                
                if (files.length === 0) {
                    listDiv.innerHTML = "<em>Nincsenek felt√∂lt√∂tt dokumentumok.</em>";
                    return;
                }

                listDiv.innerHTML = files.map(f => `
                    <div class="file-item">
                        <span><strong>${f.name}</strong> <small>(${(f.size / 1024).toFixed(1)} KB)</small></span>
                        <button class="delete-btn" onclick="deleteFile('${f.name}')">T√∂rl√©s</button>
                    </div>
                `).join('');
            } catch (err) {
                listDiv.innerHTML = "‚ö†Ô∏è Nem siker√ºlt a f√°jllista lek√©r√©se.";
            }
        }

        async function deleteFile(filename) {
            if (!confirm(`Biztosan t√∂r√∂lni szeretn√©d a(z) ${filename} f√°jlt? Az index √∫jra√©p√ºl.`)) return;
            
            try {
                const res = await fetch(`/files/${tenant_id}/${filename}`, { method: 'DELETE' });
                if (res.ok) {
                    refreshFileList();
                }
            } catch (err) {
                alert("Hiba a t√∂rl√©s sor√°n.");
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('pdfFile');
            const status = document.getElementById('uploadStatus');
            
            if (fileInput.files.length === 0) {
                alert("K√©rlek, v√°lassz ki egy PDF f√°jlt!");
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("tenant_id", tenant_id);

            status.innerText = "‚è≥ Feldolgoz√°s √©s indexel√©s... Ez eltarthat egy ideig.";
            
            try {
                const res = await fetch("/upload", { method: "POST", body: formData });
                if (res.ok) {
                    status.innerText = "‚úÖ Sikeres felt√∂lt√©s!";
                    fileInput.value = "";
                    refreshFileList();
                }
            } catch (err) {
                status.innerText = "‚ùå Hiba t√∂rt√©nt.";
            }
        }

        async function askChat() {
        const input = document.getElementById('userInput');
        const chatWin = document.getElementById('chat-window');
        const question = input.value.trim();
        if (!question) return;

        chatWin.innerHTML += `<div class="message user-msg">${question}</div>`;
        input.value = "";

        const aiDiv = document.createElement("div");
        aiDiv.className = "message ai-msg";
        aiDiv.innerHTML = "<em>...</em>";
        chatWin.appendChild(aiDiv);
        chatWin.scrollTop = chatWin.scrollHeight;

        try {
            const res = await fetch("/chat/stream", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    message: question,
                    history: chatHistory,
                    tenant_id: tenant_id,
                    session_id: currentSessionId // Bek√ºldj√ºk a session ID-t!
                })
            });

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let fullAnswer = "";
            aiDiv.innerHTML = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                fullAnswer += decoder.decode(value);
                aiDiv.innerText = fullAnswer;
                chatWin.scrollTop = chatWin.scrollHeight;
            }

            chatHistory.push({ role: "human", content: question });
            chatHistory.push({ role: "assistant", content: fullAnswer });
        } catch (err) {
            aiDiv.innerHTML = "‚ùå Hiba t√∂rt√©nt.";
        }
    }
</script>
</body>
</html>