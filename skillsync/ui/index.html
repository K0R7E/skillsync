<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>SkillSync MVP</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; background-color: #f4f7f6; }
        .box { background: white; border: 1px solid #ddd; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        #chat-window { height: 400px; overflow-y: auto; background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-direction: column; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 80%; }
        .user-msg { background: #007bff; color: white; align-self: flex-end; }
        .ai-msg { background: #e9ecef; color: #333; align-self: flex-start; }
        input[type="text"] { width: 75%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; }
        button { padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #218838; }
        .source-info { font-size: 0.75rem; color: #777; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>üß† SkillSync V√°llalati Asszisztens</h1>

    <div class="box">
        <h3>üìÑ Dokumentum felt√∂lt√©se (Tenant: default)</h3>
        <input type="file" id="pdfFile" accept=".pdf">
        <button onclick="uploadFile()">Felt√∂lt√©s √©s Indexel√©s</button>
        <p id="uploadStatus"></p>
    </div>

    <div class="box">
        <h3>üí¨ Intelligens Chat</h3>
        <div id="chat-window"></div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="userInput" placeholder="K√©rdezz a dokumentumokr√≥l..." onkeypress="if(event.key==='Enter') askChat()">
            <button onclick="askChat()">K√ºld√©s</button>
        </div>
    </div>

    <script>
        let chatHistory = [];

        // --- FELT√ñLT√âS FUNKCI√ì ---
        async function uploadFile() {
            const fileInput = document.getElementById('pdfFile');
            const status = document.getElementById('uploadStatus');
            
            if (fileInput.files.length === 0) {
                alert("K√©rlek, v√°lassz ki egy PDF f√°jlt!");
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            status.innerText = "‚è≥ Feldolgoz√°s folyamatban... Ez eltarthat egy ideig.";
            
            try {
                const res = await fetch("/upload", { method: "POST", body: formData });
                const data = await res.json();
                status.innerText = "‚úÖ " + (data.message || "Sikeres felt√∂lt√©s!");
            } catch (err) {
                status.innerText = "‚ùå Hiba t√∂rt√©nt a felt√∂lt√©s sor√°n.";
                console.error(err);
            }
        }

        // --- CHAT √âS STREAMING FUNKCI√ì ---
        async function askChat() {
            const input = document.getElementById('userInput');
            const chatWin = document.getElementById('chat-window');
            const question = input.value.trim();
            
            if (!question) return;

            // Felhaszn√°l√≥i bubor√©k
            chatWin.innerHTML += `<div class="message user-msg">${question}</div>`;
            input.value = "";

            // AI v√°lasz bubor√©k el≈ëk√©sz√≠t√©se
            const aiDiv = document.createElement("div");
            aiDiv.className = "message ai-msg";
            aiDiv.innerHTML = "<em>Gondolkodom...</em>";
            chatWin.appendChild(aiDiv);
            chatWin.scrollTop = chatWin.scrollHeight;

            try {
                const res = await fetch("/chat/stream", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        message: question,
                        history: chatHistory 
                    })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let fullAnswer = "";
                aiDiv.innerHTML = ""; // T√∂r√∂lj√ºk a "Gondolkodom..." feliratot

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    fullAnswer += chunk;
                    aiDiv.innerText = fullAnswer; // Biztons√°gos sz√∂vegmegjelen√≠t√©s
                    chatWin.scrollTop = chatWin.scrollHeight;
                }

                // El≈ëzm√©nyek friss√≠t√©se a mem√≥ri√°hoz
                chatHistory.push({ role: "human", content: question });
                chatHistory.push({ role: "assistant", content: fullAnswer });

            } catch (err) {
                aiDiv.innerHTML = "‚ùå Hiba t√∂rt√©nt a v√°laszad√°s sor√°n.";
                console.error(err);
            }
        }
    </script>
</body>
</html>